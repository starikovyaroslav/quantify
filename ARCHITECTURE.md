# Архитектура QuantTxt

## Обзор системы

QuantTxt - это высокопроизводительная система для преобразования изображений в текстовые файлы с использованием оптического квантования Unicode-символов.

## Компоненты системы

### 1. API Gateway (FastAPI)

**Роль:** Точка входа для всех запросов

**Функции:**

- Прием и валидация запросов
- Rate limiting на уровне приложения
- Маршрутизация запросов
- Управление задачами

**Технологии:**

- FastAPI (асинхронный веб-фреймворк)
- Pydantic (валидация данных)
- Uvicorn (ASGI сервер)

### 2. Очередь задач (Celery + Redis)

**Роль:** Асинхронная обработка задач

**Функции:**

- Постановка задач в очередь
- Распределение задач между воркерами
- Отслеживание статуса задач
- Retry механизм

**Технологии:**

- Celery (распределенная очередь задач)
- Redis (брокер сообщений)

### 3. Воркеры обработки (Celery Workers)

**Роль:** Выполнение задач квантования

**Функции:**

- Загрузка изображений
- Выполнение алгоритма квантования
- Сохранение результатов
- Обновление статуса задач

**Масштабирование:**

- Горизонтальное масштабирование (добавление воркеров)
- Автоматическая балансировка нагрузки

### 4. Алгоритм квантования

**Компоненты:**

#### 4.1. Цветовое квантование

- Упрощение палитры изображения
- Сохранение основных цветовых переходов
- Адаптация к качеству (1-10)

#### 4.2. Оптическое квантование

- Вычисление визуального веса пикселей
- Подбор Unicode-символов по оптическому весу
- Учет плотности штрихов и формы символов

#### 4.3. Генерация текста

- Создание матрицы символов
- Формирование UTF-16 LE файла

### 5. Reverse Proxy (Nginx)

**Роль:** Защита и оптимизация

**Функции:**

- Rate limiting на уровне сети
- Балансировка нагрузки
- Кэширование статики
- Защита от DDoS
- SSL/TLS терминация (в продакшене)

**Конфигурация:**

- 100 запросов/минуту на IP
- 1000 запросов/час на IP
- Максимум 10 соединений на IP
- Максимальный размер тела запроса: 10MB

### 6. Хранилище данных

#### Redis

- Очереди задач
- Кэширование результатов
- Rate limiting счетчики
- Сессии

#### PostgreSQL

- Метаданные задач
- Статистика использования
- Логи операций

#### Файловая система

- Временные загрузки (uploads/)
- Результаты квантования (results/)

## Поток обработки запроса

```
1. Клиент → Nginx
   ↓
2. Nginx проверяет rate limit
   ↓
3. Nginx → FastAPI
   ↓
4. FastAPI валидирует запрос
   ↓
5. FastAPI сохраняет файл
   ↓
6. FastAPI создает задачу в Redis
   ↓
7. FastAPI возвращает task_id
   ↓
8. Celery Worker забирает задачу
   ↓
9. Worker выполняет квантование
   ↓
10. Worker сохраняет результат
   ↓
11. Worker обновляет статус в Redis
   ↓
12. Клиент запрашивает результат
   ↓
13. FastAPI возвращает файл
```

## Масштабирование

### Горизонтальное масштабирование

1. **API серверы:**

   - Добавление новых инстансов FastAPI
   - Балансировка через Nginx (least_conn)

2. **Воркеры:**

   - Добавление Celery workers
   - Автоматическое распределение задач

3. **Redis:**

   - Redis Cluster для высокой доступности
   - Репликация для чтения

4. **База данных:**
   - Master-Slave репликация
   - Шардирование при необходимости

### Вертикальное масштабирование

- Увеличение ресурсов контейнеров
- Оптимизация алгоритма квантования
- Кэширование часто используемых результатов

## Защита от DDoS

### Многоуровневая защита

1. **Nginx уровень:**

   - Rate limiting по IP
   - Ограничение соединений
   - Timeout настройки

2. **Приложение уровень:**

   - Rate limiting middleware
   - Валидация входных данных
   - Ограничение размера файлов

3. **Инфраструктура:**
   - CloudFlare или подобный сервис
   - Firewall правила
   - Мониторинг аномалий

### Circuit Breaker

- Автоматическое отключение при перегрузке
- Graceful degradation
- Мониторинг здоровья сервисов

## Мониторинг

### Метрики

- Количество запросов
- Время обработки
- Ошибки
- Использование ресурсов
- Размер очереди задач

### Инструменты

- Prometheus (метрики)
- Grafana (визуализация)
- ELK Stack (логи)
- Sentry (ошибки)

## Безопасность

1. **Валидация:**

   - Проверка типов файлов
   - Ограничение размера
   - Санитизация имен файлов

2. **Изоляция:**

   - Docker контейнеры
   - Ограничение ресурсов
   - Read-only файловые системы где возможно

3. **Секреты:**
   - Переменные окружения
   - Secrets management (Vault, AWS Secrets Manager)

## Производительность

### Оптимизации

1. **Алгоритм:**

   - Векторизация с NumPy
   - Кэширование Unicode-символов
   - Оптимизация цветового квантования

2. **Инфраструктура:**

   - Асинхронная обработка
   - Connection pooling
   - Кэширование результатов

3. **Ожидаемая производительность:**
   - Обработка 200x200: 0.5-2 сек
   - Пропускная способность: до 1000 req/s
   - Поддержка 10,000 задач в очереди

## Развертывание

### Docker Compose (разработка/тестирование)

```bash
docker-compose up -d
```

### Kubernetes (продакшен)

- Deployment для API
- Deployment для Workers
- StatefulSet для Redis
- StatefulSet для PostgreSQL
- Service и Ingress
- HorizontalPodAutoscaler

### CI/CD

- GitHub Actions / GitLab CI
- Автоматическое тестирование
- Автоматический деплой
- Blue-Green deployment
